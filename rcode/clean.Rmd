---
title: "clean"
author: "Claire Jellison"
date: "12/27/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(stringr)
library(varhandle)
library(tidyr)
library(matrixStats)
library(gender)
```


#Clean zips 
```{r}
prepzip <- function(zips){
zips <- zips %>% 
  rename(
   urlsolid = X,
    zip = X0 
  ) 
zips
} 

zip2 <- prepzip(zip2)
#zip2 <- prepzip(zip2)
```

#Clean dhist
```{r}
prepdhist <- function(dhist){ #switch to booleans, merge with zips
dhist <- left_join(dhist, zip2, by = 'urlsolid') 
dhist$is_anonymous <- str_detect(dhist$is_anonymous, "True")
dhist$verified <- str_detect(dhist$verified, "True")
dhist$is_offline <- str_detect(dhist$is_offline, "True")
dhist
}

laglead <- function(fulldf){ #add the lags and leads
fulldf <- fulldf %>% group_by(as.factor(urlsolid)) %>% 
  arrange(created_at) %>% 
  mutate(lag1 = lag(amount,n = 1L), lag2 = lag(amount,n = 2L), lag3= lag(amount,n = 3L), lag4= lag(amount,n = 4L), lag5= lag(amount,n = 5L), lag6 = lag(amount,n = 6L), lag7 = lag(amount,n = 7L), lag8= lag(amount,n = 8L), lag9= lag(amount,n = 9L), lag10= lag(amount,n = 10L), alag1 = lag(is_anonymous,n = 1L), alag2 = lag(is_anonymous,n = 2L), alag3= lag(is_anonymous,n = 3L), alag4= lag(is_anonymous,n = 4L), alag5= lag(is_anonymous,n = 5L), alag6 = lag(is_anonymous,n = 6L), alag7 = lag(is_anonymous,n = 7L), alag8= lag(is_anonymous,n = 8L), alag9= lag(is_anonymous,n = 9L), alag10= lag(is_anonymous,n = 10L), glag1 = lag(is_female,n = 1L), glag2 = lag(is_female,n = 2L), glag3= lag(is_female,n = 3L), glag4= lag(is_female,n = 4L), glag5= lag(is_female,n = 5L), glag6 = lag(is_female,n = 6L), glag7 = lag(is_female,n = 7L), glag8= lag(is_female,n = 8L), glag9= lag(is_female,n = 9L), glag10= lag(is_female,n = 10L))

fulldf$alag1 <- as.integer(as.logical(fulldf$alag1)) #switches from true/false to 0/1
fulldf$alag2 <- as.integer(as.logical(fulldf$alag2))
fulldf$alag3 <- as.integer(as.logical(fulldf$alag3))
fulldf$alag4 <- as.integer(as.logical(fulldf$alag4))
fulldf$alag5 <- as.integer(as.logical(fulldf$alag5))
fulldf$alag6 <- as.integer(as.logical(fulldf$alag6))
fulldf$alag7 <- as.integer(as.logical(fulldf$alag7))
fulldf$alag8 <- as.integer(as.logical(fulldf$alag8))
fulldf$alag9 <- as.integer(as.logical(fulldf$alag9))
fulldf$alag10 <- as.integer(as.logical(fulldf$alag10))

fulldf <- fulldf %>% mutate(histavg = case_when(
  lagtype == "five" ~ (lag1 + lag2 + lag3 + lag4 + lag5)/5, 
  lagtype == "ten" | lagtype == "unknown" ~ (lag1 + lag2 + lag3 + lag4 + lag5 + lag6 + lag7 + lag8 + lag9 + lag10)/10)) %>%
  mutate(anonprop = case_when(
  lagtype == "five" ~ (alag1 + alag2 + alag3 + alag4 + lag5)/5, 
  lagtype == "ten" | lagtype == "unknown" ~ (alag1 + alag2 + alag3 + alag4 + alag5 + alag6 + alag7 + alag8 + alag9 + alag10)/10))

fulldf <- fulldf %>% select( -lag6, -lag7, -lag8, -lag9, -lag10,-alag2, - alag3, - alag4, - alag5, -alag6, -alag7, -alag8, -alag9, -alag10, -glag2, - glag3, - glag4, - glag5, -glag6, -glag7, -glag8, -glag9, -glag10 )
  
fulldf 
}

#nts: had to run devtools::install_github("ropensci/genderdata") 
addgender <- function(dhist){ #add the gender based on first names by social security 
  firstname <- word(dhist$name, 1)
  firstname<- as.data.frame(firstname)
  dfull <- bind_cols(dhist, firstname)
  genderdf <- gender(as.character(dfull$firstname), method = "ssa") 
  genderdf$firstname <- genderdf$name
  genderdf <- distinct(genderdf) %>% select(-proportion_male, -proportion_female, -year_min, -year_max)
  finaldf <- left_join(dfull, genderdf, by = "firstname") 
  finaldf$is_female <- as.integer(str_detect(finaldf$gender, "female")) #get boolean for is female
  finaldf 
}

leaddate <- function(dhist){
  dhist <- dhist %>% mutate(createdxtslead = lead(createdxts,n = 1L))
}

fixdate <- function(date){ 
  z <- as.POSIXct(date, usetz = TRUE, format="%Y-%m-%dT%H:%M:%OS")  #look at ?strptime for documentation %Y-%m-%dT%H:%M:%S
z}

checkdateforlags <- function(dhist){  #nice this works
  dhist <- dhist %>%
  mutate(lagtype = case_when(
    createdxts <  ymd_hms("2019-06-01 01:00:00") & createdxts > ymd_hms("2016-06-01 01:00:00")  ~ "unknown",
    createdxts <  ymd_hms("2016-06-01 01:00:00")   ~ "ten",
    createdxts >  ymd_hms("2019-06-01 01:00:00")  ~ "five"
  ))
}

cleandhist <- function(dhist){
  dhist <- prepdhist(dhist)
  dhist <- dhist %>% mutate(createdxts = fixdate(created_at))
  dhist <- leaddate(dhist)
  dhist <- checkdateforlags(dhist)
  dhist <- addgender(dhist)
  dhist <- laglead(dhist)
}

```

```{r}
dhist2 <- cleandhist(dhist2)

head(dhist2,20)

```


### Clean campattributes 

```{r}
#stuff in stringr 
#str_trim = trim leading and trailing white space 
#str_pad = pad with additional characters 
#str_detect = detects a pattern, returns TRUE/FALSE 
#str_replace = find and replace a pattern 
```

```{r}
getdigits <- function(string){
  list(regmatches(string,gregexpr("[[:digit:]]+\\.*[[:digit:]]*",string)))
}

cleanattributes <- function(dfatt){ 
  dfatt <- dfatt[ , -1]
  dfatt$goalamt <- gsub("'raised of", "", dfatt$goalamt,
     ignore.case = FALSE)
  dfatt$goalamt <- gsub("goal'", "", dfatt$goalamt,
     ignore.case = FALSE)
  dfatt$goalamt<- gsub("[[:punct:]]", "", dfatt$goalamt,  #yo you can also use str_replace if ya want
     ignore.case = FALSE)
  dfatt$amtraised<- gsub("[[:punct:]]", "", dfatt$amtraised,
     ignore.case = FALSE)
  dfatt$goalamt <- as.integer(dfatt$goalamt)
  dfatt$amtraised <- as.integer(dfatt$amtraised)
  dfatt$terminatedbool <- str_detect(dfatt$terminated, "donations") #this doesn't work? DOUBLE CHECK
  dfatt$nonprofit <- str_detect(dfatt$nonprofit., "Registered")
  dfatt<- dfatt%>% mutate(progress = amtraised/goalamt) %>% rename(urlsolid = urlname)
}


```

```{r}
#campatt1 <- cleanattributes(campatt1)
campatt2 <- cleanattributes(campatt2)
head(campatt2)
```

#Merge important parts of dhist and campatt

```{r}
campatt2short <- campatt2 %>% select(urlsolid, category, created, terminated, nonprofit, amtraised, goalamt, progress)
dfc2 <- left_join(dhist2, campatt2short, by = "urlsolid")
head(dfc2,90)
```


#checking that it looks right below 

```{r}
nrow(dhist1)
nrow(dhist2)
dfc <- dhist1 %>% group_by(urlsolid) %>% summarise(numdonations = n_distinct(donation_id))
dfcc <- dhist2 %>% group_by(urlsolid) %>% summarise(numdonations = n_distinct(donation_id))
nrow(dfc)
nrow(dfcc)
dfc2 <- dfc %>% filter(numdonations %% 100 == 0) 
dfcc2 <- dfcc %>% filter(numdonations %% 100 == 0) 
nrow(dfc2)
nrow(dfcc2)
head(dfc2,200)

```


```{r}
pathhisttry <- "/Users/CJ/Desktop/thesisdata/p1/donationhistory.csv" 
dhisttry <- read.csv(pathhisttry)
dhisttry <- tbl_df(dhisttry)
tryatt<- "/Users/CJ/Desktop/thesisdata/p1/campattributes.csv" 
dhisttryatt <- read.csv(tryatt)
dhisttryatt <- tbl_df(dhisttryatt)
dfc <- dhisttry %>% group_by(urlsolid) %>% summarise(numdonations = n_distinct(donation_id))
nrow(dhisttryatt)
nrow(dfc)
nrow(dhisttry)
head(dfc2,200)
dfc2 <- dfc %>% filter(numdonations >= 1000) 


```



```{r}
sdp<- "/Users/CJ/Desktop/thesisdata/p1/campsbyzip1.csv" 
sdd <- read.csv(sdp)
sdd<- tbl_df(sdd)
head(sdd)
nrow(sdd)
sddf <- sdd %>% group_by(X0) %>% summarise(total = n_distinct(X)) %>% filter(total >= 20)
head(sddf)
nrow(sddf)

```

