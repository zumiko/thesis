---
title: "summary stats"
author: "Claire Jellison"
date: "12/27/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyverse)
library(lubridate)
library(quantmod)
library(ggpointdensity)
library(stringr)
```


```{r}
df <- read.csv("dhist1to4.csv")
dhist <- tbl_df(df)

df2 <- read.csv("dhist5to8.csv")
dhisttest <- tbl_df(df2)
dhisttest <- sumstats(dhisttest)

dhistall <- read.csv("dfc.csv")
dfc <- read.csv("dfc.csv")

dhistall$category<- gsub("[^A-Za-z0-9 ]","",dhistall$category)
dhistall$category<- str_replace(dhistall$category,"fundraiser","")
dhistall$gender <- as.character(dhistall$gender)
dhistall$nbrSims[is.na(dhistall$gender)] <- "unknown"
```


```{r}
#corresponds to table 2.1
nrow(dhistall)
mean(dhistall$amount)
sd(dhistall$amount)
sum(dhistall$amount)
median(dhistall$amount)


anonhist <- dhistall %>% dplyr::filter(gender == "anonymous")
nrow(anonhist)
mean(anonhist$amount)

malehist <- dhistall %>% dplyr::filter(gender == "male")
nrow(malehist)
mean(malehist$amount)

femalehist <- dhistall %>% dplyr::filter(gender == "female")
nrow(femalehist)
mean(femalehist$amount)

unknownhist <- dhistall %>% dplyr::filter(is.na(gender))
nrow(unknownhist)
mean(unknownhist$amount)

dhistsum <- dhistall %>% group_by(category) %>% group_by(gender, add = TRUE) %>% summarize(total = n(), meand = mean(amount)) %>% arrange(desc(total), .by_group = TRUE)

```



```{r}
#this is figure 2.4 
dfc %>% dplyr::filter(terminated != TRUE) %>% distinct(urlsolid, .keep_all = TRUE) %>% mutate(progress = progress *100) %>%
ggplot( aes(x = progress)) + geom_histogram(aes(y=..density..), colour="black", fill="white") +
 geom_density(alpha=.2, fill="#FF6666") + xlim(0,150) 
ggsave("pdffund.png", width = 7, height = 4, units = "in")
```



```{r}
#this is figure 2.3
dhistall %>% 
  ggplot(aes(x = amount)) + 
  geom_histogram(binwidth = 5, fill = "white", color="steelblue", position = "identity") +
  xlim(0,120)
ggsave("amtdist.png", width = 7, height = 4, units = "in")
```


```{r}
#this is figure 2.5
dhistall$month <- fct_relevel(dhistall$month, levels = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"))
                           
ggplot(dhistall, aes(x = month, y = amount))  +
  geom_boxplot() + ylim(0,150)


ggsave("monthdonations.png", width = 7, height = 4, units = "in")
```


```{r}
dhistall %>% 
  group_by(dow) %>% 
  summarise(meand = mean(amount)) %>% 
  ggplot(aes(x = dow, y = meand))  +
  geom_point() + ylim(0,150)
```


```{r}
#this is figure 2.6
ggplot(dhistall, aes(x = hourofday, y = amount)) +
  geom_pointdensity() +
  scale_color_viridis_c() + 
  ylim(0,250)
ggsave("timeofdaydonations.png", width = 7, height = 4, units = "in")
```


```{r}


dhistall %>%   
  group_by(category) %>% 
  summarize(meanamount = mean(amount)) %>% 
  arrange(meanamount) %>% 
  dplyr::filter(category != "NA") %>% 
  ggplot(aes(x = reorder(category, -meanamount), y = meanamount)) + 
  geom_bar(stat = "identity", color="steelblue", fill="white") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  ylab("mean donation") +
  xlab("category")

ggsave("mmeanbycate.png", width = 7, height = 4, units = "in")

dhistall %>%   
  mutate(gender = replace_na(gender, "unknown")) %>%
  group_by(category, gender) %>% 
  summarize(countamount = n()) %>% 
  dplyr::filter(category != "NA") %>% 
  ggplot(aes(fill = gender, x = reorder(category, -countamount), y = countamount)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  scale_fill_brewer(palette="Dark2") + 
  ylab("total donations") +
  xlab("category")

ggsave("totbycate.png", width = 7, height = 4, units = "in")

```


```{r}
lambda <- nrow(dhistall$timeafter)/sum(dhistall$timeafter)
eq = function(x){lambda * exp(-lambda*x)}

ggplot(dhistall, aes(x = timeafter))  +
  geom_histogram(bins = 30) + xlim(0, 50000) + 
  stat_function(fun=eq)

x <- seq(0, 1000, length.out=1000)
dat <- data.frame(x=x, px=dexp(x, rate=lambda))
ggplot(dat, aes(x=x, y=px)) + geom_line()

ggplot(data.frame(x=c(1, 50000)), aes(x=x)) + 
  stat_function(fun=eq)

```

```{r}
#for each campaign identify a large donation as 1/2 stdev above mean 

dg2 <- dfc %>% 
  dplyr::filter(countd >= 100) %>%
  group_by(urlsolid) %>% 
  summarize(meanofcamp = mean(amount), halfsd = .5*sd(amount))

dg <- dfc %>% 
  dplyr::filter(countd >= 1) %>%
  select(urlsolid, amount, donation_id, lag1, lag2, lag3, lag4, lag5, lag6, lag7, lag8, lag9, lag10) %>%
    group_by(urlsolid) %>% 
    mutate(lead1 = dplyr::lead(amount,n = 1L), lead2 = dplyr::lead(amount,n = 2L), lead3= dplyr::lead(amount,n = 3L), lead4= dplyr::lead(amount,n = 4L), lead5= dplyr::lead(amount,n = 5L), lead6 = dplyr::lead(amount,n = 6L), lead7 = dplyr::lead(amount,n = 7L), lead8= dplyr::lead(amount,n = 8L), lead9= dplyr::lead(amount,n = 9L), lead10= dplyr::lead(amount,n = 10L)) %>% 
  left_join(dg2, by = "urlsolid") %>%
  mutate(largeness = case_when(
    amount >= meanofcamp + .5*halfsd ~ "quarterabove",
    amount <= meanofcamp - .5*halfsd ~ "quarterbelow",
    TRUE ~ "ignore"
  ))
  
m<- dg %>% select(!is.na(lag1),!is.na(lag1),!is.na(lag1)) %>% 
  mutate(amount = amount - meanofcamp, lag1 = lag1 - meanofcamp, lag2 = lag2 - meanofcamp, lag3 = lag3 - meanofcamp, lag4 = lag4 - meanofcamp, lag5 = lag5 - meanofcamp, lag6 = lag6 - meanofcamp, lag7 = lag7 - meanofcamp, lag8 = lag8 - meanofcamp, lag9 = lag9 - meanofcamp, lag10 = lag10 - meanofcamp, lead1 = lead1 - meanofcamp, lead2 = lead2 - meanofcamp, lead3 = lead3 - meanofcamp, lead4 = lead4 - meanofcamp, lead5 = lead5 - meanofcamp, lead6 = lead6 - meanofcamp, lead7 = lead7 - meanofcamp, lead8 = lead8 - meanofcamp, lead9 = lead9 - meanofcamp, lead10 = lead10 - meanofcamp) %>%
  group_by(largeness) %>% 
  summarise(mamount = mean(amount), mlag1 = mean(lag1), mlag2 = mean(lag2), mlag3 = mean(lag3), mlag4 = mean(lag4), mlag5 = mean(lag5), mlag6 = mean(lag6), mlag7 = mean(lag7), mlag8 = mean(lag8), mlag9 = mean(lag9), mlag10 = mean(lag10), mlead1 = mean(lead1), mlead2 = mean(lead2), mlead3 = mean(lead3), mlead4 = mean(lead4), mlead5 = mean(lead5), mlead6 = mean(lead6), mlead7 = mean(lead7), mlead8 = mean(lead8), mlead9 = mean(lead9), mlead10 = mean(lead10))
  

m <- m %>% select(largeness, mlag5, mlag4, mlag3, mlag2, mlag1, mlead5, mlead4, mlead3, mlead2, mlead1) %>% melt(value.name = "value")

m %>% dplyr::filter(largeness == "quarterabove") %>% mutate(variable = fct_relevel(variable, levels = c("mlag5", "mlag4", "mlag3", "mlag2", "mlag1", "mlead1", "mlead2", "mlead3", "mlead4", "mlead5"))) %>% ggplot(aes(x = variable, y= value)) + geom_bar(stat = "identity")

m %>% dplyr::filter(largeness == "quarterbelow") %>% mutate(variable = fct_relevel(variable, levels = c("mlag5", "mlag4", "mlag3", "mlag2", "mlag1", "mlead1", "mlead2", "mlead3", "mlead4", "mlead5"))) %>% ggplot(aes(x = variable, y= value)) + geom_bar(stat = "identity")

```
